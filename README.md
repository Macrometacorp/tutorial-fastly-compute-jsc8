# Macrometa JSC8 driver on Fastly Compute@Edge

This tutorial will demonstrate CRUD operation on GDN Collection using a jsc8 driver with Fastly Compute edge.

### Known limitations and issues

-   Fastly Compute@Edge does not support WebSocket connection so you will not be able to use JSC8 producer/subscriber features for stream/collection streams
-   Requests forwarded to a backend will transit the Fastly cache, and the response may come from cache. Where a request doesn't find a matching result in cache, it will be sent to the backend(Macrometa GDN). As of now, Fastly only allow you to set `CacheOverride` parameter to handle caching so if you want to clear cache you can follow [Fastly's Purge Cache doc](https://docs.fastly.com/en/guides/purging-all-content)

## Prerequisite

1. Create API token by following [Fastly API Token doc](https://docs.fastly.com/en/guides/using-api-tokens#creating-api-tokens). The generated token will be used to configure Fastly CLI. **Create Token with `Global API access` Scope**
2. To install and configure Fastly CLI follow [Fastly CLI Doc](https://developer.fastly.com/reference/cli/)
3. Create Fastly Compute@Edge service

    ```
    $ fastly service create --name="Fastly Compute-JSC8 tutorial" --type=wasm
    SUCCESS: Created service AAAAAAAAAAA
    ```

4. Update `fastly.toml` file with service ID generated by the above command
5. Create Fastly Compute@Edge backend to connect to GDN
    ```
    $ fastly backend create --version=latest --name="gdn_url" --address="api-gdn.paas.macrometa.io" --port=443
    SUCCESS: Created backend gdn_url (service AAAAAAAAAAA version 1)
    ```

## How to Run and Publish on Fastly Compute@Edge

```
git clone git@github.com:Macrometacorp/tutorial-fastly-compute-jsc8.git
cd tutorial-fastly-compute-jsc8
npm install
npm run dev
npm run deploy
```

In the above deployment command, it will prompt you for a domain, you can either select Fastly generated domain or type your own. Once deployment is complete you will use that domain to access the service

## Prerequisite for using JSC8 with Fastly Compute@Edge

1. Install below Packges

    ```
    npm install path-browserify
    npm install url
    ```

2. Add the following code snippet in webpack.config.js. This is to fix [Webpack 5 Node.js Polyfills Removed](https://webpack.js.org/blog/2020-10-10-webpack-5-release/#automatic-nodejs-polyfills-removed) issue

    ```
    resolve: {
       extensions: [".web.js", ".web.ts", ".js", ".ts", ".json"],
       fallback: {
           path: require.resolve("path-browserify"),
           url: require.resolve("url"),
       },
    },
    ```

3. Add the below code snippet in `fastly.toml` file. It allows Fastly Compute to forward API requests from the JSC8 driver to Macrometa GDN. **This is only used when running dev server**
    ```
    [local_server]
     [local_server.backends]
       [local_server.backends.gdn_url]
         url = "https://api-gdn.paas.macrometa.io"
    ```

## How to use JSC8 in Fastly Compute@Edge

1. Create jsC8 client

    ```
    const jsC8 = require("jsc8")
    jsc8Client = new jsC8({
       url: "https://gdn.paas.macrometa.io",
       fabricName: "xxxx",
       apiKey: "xxxx",
       agent: fetch,
       agentOptions: {
           backend: "gdn_url",
           cacheOverride: new CacheOverride("override", { ttl: 0 }),
       },
    })
    ```

    > For authentication, this tutorial uses JSC8 client's login method for but you can provide an API key generated using Macrometa GDN GUI as shown above.

    **Note: Please note the passing `backend` parameter in `agentOptions` is required. Value of `backend` will be the `--name` parameter value you have passed while creating Fastly Compute Backend in Prerequisite Point 5.**

2. Once you have created the jsC8 client, you will be able to use all the methods which will enable you to read, write, manipulate data in Macrometa GDN
   **Sample**
    ```
    const collectioName= "fastly_compute_tutorial"
    await jsc8Client.hasCollection(collectionName) //Check if given collection exists or not
    await jsc8Client.insertDocument(collectionName, content) //Insert data into collection
    ```

## References

-   [JSC8 Driver](https://www.npmjs.com/package/jsc8)
-   [Fastly Compute@Edge JS Starter Kit](https://github.com/fastly/compute-starter-kit-javascript-default)
-   [Compute@Edge Examples](https://developer.fastly.com/solutions/examples/javascript/)
